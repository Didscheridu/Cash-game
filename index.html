<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPERIUM: TITAN EDITION</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CORE DESIGN SYSTEM --- */
        :root {
            --bg-deep: #050505;
            --bg-panel: #121212;
            --bg-card: #1e1e1e;
            --border: #333;
            
            --neon-blue: #00f3ff;
            --neon-green: #00ff9d;
            --neon-red: #ff0055;
            --neon-gold: #ffbd00;
            --neon-purple: #bd00ff;
            
            --text-main: #ffffff;
            --text-dim: #888;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-deep); 
            color: var(--text-main); 
            margin: 0; height: 100vh; 
            overflow: hidden; 
            display: flex;
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-panel); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 20px; z-index: 100;
        }
        .logo { 
            font-size: 24px; font-weight: 900; 
            color: var(--neon-blue); text-transform: uppercase; 
            letter-spacing: 4px; margin-bottom: 40px;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.5);
            display: flex; align-items: center; gap: 10px;
        }
        .nav-item {
            padding: 15px; margin-bottom: 8px;
            color: var(--text-dim); cursor: pointer;
            border-radius: 8px; transition: 0.3s;
            display: flex; align-items: center; gap: 15px;
            font-weight: 600;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(0,243,255,0.1), transparent); 
            color: var(--neon-blue); border-left: 3px solid var(--neon-blue);
        }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        .top-bar {
            height: 70px; background: rgba(18,18,18,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
        }
        
        .stat-group { display: flex; gap: 30px; }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 18px; font-weight: bold; font-family: monospace; }
        .val-money { color: var(--neon-green); text-shadow: 0 0 10px rgba(0,255,157,0.3); }

        .content-view { 
            flex: 1; padding: 30px; overflow-y: auto; display: none; 
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .content-view.active { display: block; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform:translateY(0); } }

        /* --- COMPONENTS --- */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; position: relative; overflow: hidden;
        }
        .card-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); 
        }
        .card-title { font-size: 16px; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }

        .btn {
            background: var(--border); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-weight: bold; transition: 0.2s; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--neon-blue); color: #000; }
        .btn-success { background: var(--neon-green); color: #000; }
        .btn-danger { background: var(--neon-red); color: white; }
        .btn-gold { background: var(--neon-gold); color: #000; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-full { width: 100%; }

        input, select {
            background: #000; border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 6px; width: 100%;
            margin-bottom: 10px; font-family: inherit;
        }
        input:focus { border-color: var(--neon-blue); }

        /* --- SPECIFIC STYLES --- */
        
        /* Company Product Cards */
        .product-card { border-left: 4px solid var(--neon-blue); }
        .progress-track { background: #000; height: 8px; border-radius: 4px; overflow: hidden; margin: 8px 0; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.2s linear; }
        .bar-prod { background: var(--neon-gold); }
        .bar-sales { background: var(--neon-green); }

        /* Stock Market */
        .stock-row { 
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; 
            padding: 15px; border-bottom: 1px solid var(--border); 
            cursor: pointer; transition: 0.2s; 
        }
        .stock-row:hover { background: rgba(255,255,255,0.05); }
        .up { color: var(--neon-green); } .down { color: var(--neon-red); }

        /* Casino Horse Track */
        .horse-track { background: #2a3a2a; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .lane { height: 40px; border-bottom: 1px dashed #555; position: relative; display: flex; align-items: center; }
        .horse { position: absolute; left: 0; font-size: 24px; transition: left 0.5s linear; }
        .finish-line { position: absolute; right: 20px; height: 100%; width: 2px; background: red; }

        /* Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); border-left: 4px solid var(--neon-blue); padding: 15px; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: white; display: flex; align-items: center; gap: 15px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 500; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--bg-card); border: 1px solid var(--border); width: 500px; padding: 30px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-layer-group"></i> TITAN OS</div>
        
        <div class="nav-item active" onclick="App.nav('dash')"><i class="fas fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="App.nav('company')"><i class="fas fa-building"></i> Konzern</div>
        <div class="nav-item" onclick="App.nav('stocks')"><i class="fas fa-chart-line"></i> Wall Street</div>
        <div class="nav-item" onclick="App.nav('estate')"><i class="fas fa-city"></i> Immobilien</div>
        <div class="nav-item" onclick="App.nav('casino')"><i class="fas fa-dice"></i> Casino Royal</div>
        
        <div style="margin-top: auto; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <div style="font-size: 12px; color: #666;">System Status</div>
            <div style="color: var(--neon-green); font-size: 12px;">‚óè Online</div>
            <button class="btn btn-sm btn-danger" style="margin-top:10px; width:100%" onclick="App.reset()">Reset Save</button>
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div class="stat-group">
                <div class="stat">
                    <span class="stat-label">Verm√∂gen</span>
                    <span class="stat-val val-money" id="ui-cash">0 ‚Ç¨</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Firmenwert</span>
                    <span class="stat-val" id="ui-val">0 ‚Ç¨</span>
                </div>
            </div>
            <div class="stat-group">
                <div class="stat" style="text-align: right;">
                    <span class="stat-label">Zeit</span>
                    <span class="stat-val" id="ui-date">Tag 1</span>
                </div>
            </div>
        </div>

        <div id="view-dash" class="content-view active">
            <h1 style="font-size: 32px; margin-bottom: 20px;">Executive Summary</h1>
            
            <div class="grid grid-3">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-wallet"></i> Liquidit√§t</span>
                    </div>
                    <h1 style="color:var(--neon-green); font-size: 36px; margin: 0;" id="dash-cash">0 ‚Ç¨</h1>
                    <p style="color:#666">Verf√ºgbares Kapital</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-users"></i> Gesamt-Personal</span>
                    </div>
                    <h1 style="color:var(--neon-blue); font-size: 36px; margin: 0;" id="dash-staff">0</h1>
                    <p style="color:#666">Mitarbeiter weltweit</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-chart-pie"></i> Gewinn/Min</span>
                    </div>
                    <h1 style="color:var(--neon-gold); font-size: 36px; margin: 0;" id="dash-profit">0 ‚Ç¨</h1>
                    <p style="color:#666">Gesch√§tzter Cashflow</p>
                </div>
            </div>

            <div class="grid grid-2" style="margin-top: 20px;">
                <div class="card" style="height: 300px;">
                    <div class="card-header"><span class="card-title">Finanzentwicklung</span></div>
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Schnellzugriff</span></div>
                    <div style="display: grid; gap: 10px;">
                        <button class="btn btn-primary" onclick="App.nav('company')">Produktion verwalten</button>
                        <button class="btn" onclick="App.nav('stocks')">Aktienkurse pr√ºfen</button>
                        <button class="btn btn-gold" onclick="App.nav('casino')">Ins Casino gehen</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-company" class="content-view">
            <div id="comp-setup" style="max-width: 500px; margin: 50px auto; text-align: center;">
                <h1 style="color:var(--neon-blue); font-size: 40px; margin-bottom: 20px;">KONZERN GR√úNDUNG</h1>
                <p style="color:#888; margin-bottom: 30px;">W√§hle einen Namen f√ºr dein Imperium.</p>
                <input id="setup-name" placeholder="Firmenname (z.B. Tesla)" style="font-size: 18px;">
                <button class="btn btn-primary btn-full" style="padding: 15px;" onclick="Company.create()">Gr√ºnden (Kostenlos)</button>
            </div>

            <div id="comp-main" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 id="comp-name-display" style="margin:0; text-transform: uppercase;">FIRMA</h1>
                    <button class="btn btn-primary" onclick="Company.openProductModal()"><i class="fas fa-plus"></i> Neues Produkt</button>
                </div>

                <div class="grid grid-4" style="margin-bottom: 30px;">
                    <div class="card">
                        <small>Unzugewiesene Mitarbeiter</small>
                        <h2 id="pool-staff" style="color: white; margin: 5px 0;">0</h2>
                        <div style="display:flex; gap: 5px;">
                            <button class="btn btn-sm btn-success" onclick="Company.hirePool(1)">+1</button>
                            <button class="btn btn-sm btn-success" onclick="Company.hirePool(10)">+10</button>
                            <button class="btn btn-sm btn-success" onclick="Company.hirePool(100)">+100</button>
                        </div>
                    </div>
                    <div class="card">
                        <small>Globale Rohstoffe</small>
                        <h2 id="pool-mats" style="color: var(--neon-gold); margin: 5px 0;">0</h2>
                        <button class="btn btn-sm btn-full" onclick="Company.buyMats()">Kaufen (Auto)</button>
                    </div>
                </div>

                <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px;">Produktlinien</h3>
                <div id="product-list" class="grid grid-2">
                    </div>
            </div>
        </div>

        <div id="view-stocks" class="content-view">
            <div class="grid grid-2" style="height: 100%;">
                <div class="card" style="display: flex; flex-direction: column;">
                    <div class="card-header"><span class="card-title">Markt</span></div>
                    <div id="stock-list" style="flex: 1; overflow-y: auto;"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title" id="stock-detail-name">W√§hle eine Aktie</span>
                        <span style="font-family: monospace; font-size: 20px;" id="stock-detail-price">--</span>
                    </div>
                    <div style="height: 300px; margin-bottom: 20px;">
                        <canvas id="stockChart"></canvas>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.3);">
                        <div style="display:flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Dein Besitz: <b id="stock-owned">0</b></span>
                            <span>Wert: <b id="stock-val">0 ‚Ç¨</b></span>
                        </div>
                        <input type="number" id="stock-amount" value="10">
                        <div class="grid grid-2">
                            <button class="btn btn-success" onclick="Stocks.trade('buy')">Kaufen</button>
                            <button class="btn btn-danger" onclick="Stocks.trade('sell')">Verkaufen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-casino" class="content-view">
            <h1 style="text-align: center; color: var(--neon-gold); margin-bottom: 40px;">CASINO ROYAL</h1>
            
            <div class="grid grid-3">
                <div class="card" style="grid-column: span 3;">
                    <div class="card-header"><span class="card-title"><i class="fas fa-horse"></i> Pferderennen</span></div>
                    <div class="horse-track" id="horse-track">
                        <div class="lane" id="lane-0"><i class="fas fa-horse horse" style="color:cyan"></i></div>
                        <div class="lane" id="lane-1"><i class="fas fa-horse horse" style="color:magenta"></i></div>
                        <div class="lane" id="lane-2"><i class="fas fa-horse horse" style="color:yellow"></i></div>
                    </div>
                    <div style="display:flex; gap: 10px; justify-content: center;">
                        <input id="horse-bet" type="number" placeholder="Einsatz" style="width: 150px; margin:0;">
                        <select id="horse-select" style="width: 150px; margin:0;">
                            <option value="0">Cyan (x3)</option>
                            <option value="1">Magenta (x3)</option>
                            <option value="2">Gelb (x3)</option>
                        </select>
                        <button class="btn btn-gold" onclick="Casino.startRace()">Starten</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><span class="card-title">Blackjack (High Card)</span></div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 40px;" id="bj-result">‚ô†Ô∏è vs ‚ô•Ô∏è</div>
                    </div>
                    <input id="bj-bet" type="number" placeholder="Einsatz">
                    <button class="btn btn-primary btn-full" onclick="Casino.playBJ()">Deal</button>
                </div>

                <div class="card">
                    <div class="card-header"><span class="card-title">Roulette</span></div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 40px; transition: 0.5s;" id="roul-wheel">üé°</div>
                    </div>
                    <input id="roul-bet" type="number" placeholder="Einsatz">
                    <div class="grid grid-2">
                        <button class="btn btn-danger" onclick="Casino.playRoulette('red')">Rot</button>
                        <button class="btn" style="background: black; color: white;" onclick="Casino.playRoulette('black')">Schwarz</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><span class="card-title">Slots</span></div>
                    <div style="text-align: center; margin: 20px 0; background: #000; padding: 10px; border-radius: 8px; border: 2px solid var(--neon-gold);">
                        <span id="slot1" style="font-size: 30px;">üçí</span>
                        <span id="slot2" style="font-size: 30px;">üçí</span>
                        <span id="slot3" style="font-size: 30px;">üçí</span>
                    </div>
                    <input id="slot-bet" type="number" placeholder="Einsatz">
                    <button class="btn btn-gold btn-full" onclick="Casino.playSlots()">Spin</button>
                </div>
            </div>
        </div>

        <div id="view-estate" class="content-view">
            <h1 style="margin-bottom: 20px;">Immobilienmarkt</h1>
            <div id="estate-list" class="grid grid-4"></div>
        </div>

    </div>

    <div id="modal-product" class="modal-overlay">
        <div class="modal">
            <h2>Neues Produkt</h2>
            <input id="new-prod-name" placeholder="Name (z.B. iPhone)">
            <label>Verkaufspreis</label>
            <input id="new-prod-price" type="number" value="100">
            <label>Komplexit√§t (Kosten)</label>
            <input id="new-prod-cost" type="range" min="10" max="500" value="50" oninput="document.getElementById('cost-disp').innerText=this.value+'‚Ç¨'">
            <div style="text-align: right; margin-bottom: 20px;" id="cost-disp">50‚Ç¨</div>
            <button class="btn btn-success btn-full" onclick="Company.createProduct()">Starten</button>
            <button class="btn btn-danger btn-full" style="margin-top: 10px;" onclick="document.getElementById('modal-product').style.display='none'">Abbrechen</button>
        </div>
    </div>

    <script>
        /* --- GAME ENGINE --- */
        const App = {
            data: {
                cash: 50000,
                day: 1,
                company: null, // { name, staffPool, products: [] }
                stocks: [],
                estates: []
            },
            tick: 0,

            init: function() {
                this.load();
                Stocks.init();
                Estate.init();
                UI.update();
                
                // Loops
                setInterval(() => this.fastLoop(), 100); // UI & Fast logic
                setInterval(() => this.slowLoop(), 1000); // Economy logic
                setInterval(() => this.save(), 10000); // Autosave
            },

            fastLoop: function() {
                Company.tick();
                UI.updateFast();
            },

            slowLoop: function() {
                this.data.day++;
                Stocks.tick();
                Estate.tick();
                UI.updateSlow();
            },

            save: function() {
                localStorage.setItem('imperium_save_v25', JSON.stringify(this.data));
                UI.toast('Spiel gespeichert', 'info');
            },

            load: function() {
                const save = localStorage.getItem('imperium_save_v25');
                if (save) {
                    this.data = JSON.parse(save);
                    if(this.data.company) {
                        document.getElementById('comp-setup').style.display = 'none';
                        document.getElementById('comp-main').style.display = 'block';
                        document.getElementById('comp-name-display').innerText = this.data.company.name;
                        Company.renderProducts();
                    }
                }
            },

            reset: function() {
                localStorage.removeItem('imperium_save_v25');
                location.reload();
            },

            nav: function(viewId) {
                document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('view-'+viewId).classList.add('active');
                event.currentTarget.classList.add('active');
                if(viewId === 'stocks') Stocks.renderChart();
            }
        };

        /* --- UI --- */
        const UI = {
            toast: function(msg, type='info') {
                const el = document.createElement('div');
                el.className = 'toast';
                let icon = type==='error' ? 'fa-exclamation-circle' : (type==='success' ? 'fa-check' : 'fa-info');
                let color = type==='error' ? 'var(--neon-red)' : (type==='success' ? 'var(--neon-green)' : 'var(--neon-blue)');
                el.style.borderLeftColor = color;
                el.innerHTML = `<i class="fas ${icon}" style="color:${color}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(el);
                setTimeout(()=>el.remove(), 3000);
            },
            updateFast: function() {
                document.querySelectorAll('#ui-cash, #dash-cash').forEach(el => el.innerText = App.data.cash.toLocaleString() + ' ‚Ç¨');
                if(App.data.company) {
                    document.getElementById('pool-mats').innerText = Math.floor(App.data.company.mats);
                    document.getElementById('pool-staff').innerText = App.data.company.staffPool;
                    document.getElementById('dash-staff').innerText = App.data.company.staffPool + App.data.company.products.reduce((a,b)=>a+b.staff,0);
                }
            },
            updateSlow: function() {
                document.getElementById('ui-date').innerText = "Tag " + App.data.day;
            }
        };

        /* --- COMPANY SYSTEM (MULTI-PRODUCT) --- */
        const Company = {
            create: function() {
                const name = document.getElementById('setup-name').value;
                if(!name) return;
                App.data.company = {
                    name: name,
                    staffPool: 0,
                    mats: 100,
                    products: []
                };
                App.data.cash += 50000; // Startbonus
                document.getElementById('comp-setup').style.display = 'none';
                document.getElementById('comp-main').style.display = 'block';
                document.getElementById('comp-name-display').innerText = name;
            },

            hirePool: function(amount) {
                const cost = amount * 500;
                if(App.data.cash >= cost) {
                    App.data.cash -= cost;
                    App.data.company.staffPool += amount;
                } else UI.toast("Nicht genug Geld!", 'error');
            },

            buyMats: function() {
                if(App.data.cash >= 1000) {
                    App.data.cash -= 1000;
                    App.data.company.mats += 500;
                }
            },

            openProductModal: function() { document.getElementById('modal-product').style.display = 'flex'; },

            createProduct: function() {
                const name = document.getElementById('new-prod-name').value;
                const price = parseInt(document.getElementById('new-prod-price').value);
                const cost = parseInt(document.getElementById('new-prod-cost').value);
                
                App.data.company.products.push({
                    id: Date.now(),
                    name: name,
                    price: price,
                    cost: cost,
                    staff: 0,
                    stock: 0,
                    progress: 0
                });
                this.renderProducts();
                document.getElementById('modal-product').style.display = 'none';
            },

            renderProducts: function() {
                const c = document.getElementById('product-list');
                c.innerHTML = '';
                App.data.company.products.forEach(p => {
                    c.innerHTML += `
                    <div class="card product-card" id="prod-${p.id}">
                        <div class="card-header">
                            <b>${p.name}</b>
                            <small>${p.price}‚Ç¨ / Stk</small>
                        </div>
                        <div class="grid grid-2">
                            <div>
                                <small>Mitarbeiter</small>
                                <h2 id="p-staff-${p.id}">${p.staff}</h2>
                                <button class="btn btn-sm btn-primary" onclick="Company.assignStaff(${p.id}, 10)">+10</button>
                                <button class="btn btn-sm" onclick="Company.removeStaff(${p.id}, 10)">-10</button>
                            </div>
                            <div>
                                <small>Lager</small>
                                <h2 style="color:var(--neon-gold)" id="p-stock-${p.id}">${Math.floor(p.stock)}</h2>
                            </div>
                        </div>
                        <div class="progress-track" style="margin-top:15px"><div id="bar-${p.id}" class="progress-bar bar-prod"></div></div>
                    </div>`;
                });
            },

            assignStaff: function(id, amount) {
                if(App.data.company.staffPool >= amount) {
                    let p = App.data.company.products.find(x => x.id === id);
                    App.data.company.staffPool -= amount;
                    p.staff += amount;
                    this.renderProducts(); // Refresh numbers
                }
            },
            
            removeStaff: function(id, amount) {
                let p = App.data.company.products.find(x => x.id === id);
                if(p.staff >= amount) {
                    p.staff -= amount;
                    App.data.company.staffPool += amount;
                    this.renderProducts();
                }
            },

            tick: function() {
                if(!App.data.company) return;
                const c = App.data.company;
                
                c.products.forEach(p => {
                    // 1. Produktion
                    if(p.staff > 0 && c.mats > 0) {
                        let speed = p.staff * 0.1; // Skalierung
                        p.progress += speed;
                        if(p.progress >= 100) {
                            // Produktion fertig
                            let amount = Math.floor(p.progress / 100);
                            if(c.mats >= amount) {
                                c.mats -= amount;
                                p.stock += amount;
                                p.progress = p.progress % 100;
                            }
                        }
                        // UI Bar update
                        let bar = document.getElementById(`bar-${p.id}`);
                        if(bar) bar.style.width = Math.min(100, p.progress) + "%";
                        let stockEl = document.getElementById(`p-stock-${p.id}`);
                        if(stockEl) stockEl.innerText = Math.floor(p.stock);
                    }

                    // 2. Verkauf (Automatisch)
                    if(p.stock > 0) {
                        // Chance depends on price vs cost
                        let attractiveness = (p.cost * 2) / p.price; 
                        let sales = Math.floor(p.stock * 0.05 * attractiveness); // 5% des Lagers
                        if(sales > 0) {
                            p.stock -= sales;
                            App.data.cash += sales * p.price;
                        }
                    }
                });
            }
        };

        /* --- STOCK MARKET --- */
        const Stocks = {
            names: ["Apple", "Tesla", "Amazon", "Nvidia", "Google", "Meta", "Microsoft"],
            chart: null,
            selected: 0,

            init: function() {
                if(App.data.stocks.length === 0) {
                    this.names.forEach((n, i) => {
                        App.data.stocks.push({
                            id: i, name: n,
                            price: Math.random() * 200 + 50,
                            history: Array(50).fill(100),
                            owned: 0, buyPrice: 0
                        });
                    });
                }
                this.renderList();
            },

            tick: function() {
                App.data.stocks.forEach(s => {
                    let change = (Math.random() - 0.5) * 5;
                    s.price = Math.max(1, s.price + change);
                    s.history.shift(); s.history.push(s.price);
                });
                if(document.getElementById('view-stocks').style.display === 'block') {
                    this.renderList();
                    this.updateChart();
                }
            },

            renderList: function() {
                const el = document.getElementById('stock-list');
                el.innerHTML = '';
                App.data.stocks.forEach(s => {
                    let change = s.price > s.history[48] ? 'up' : 'down';
                    el.innerHTML += `
                    <div class="stock-row" onclick="Stocks.select(${s.id})">
                        <div><b>${s.name}</b></div>
                        <div class="${change}">${s.price.toFixed(2)}</div>
                        <div>${s.owned}</div>
                    </div>`;
                });
            },

            select: function(id) {
                this.selected = id;
                this.updateChart();
            },

            updateChart: function() {
                const s = App.data.stocks[this.selected];
                document.getElementById('stock-detail-name').innerText = s.name;
                document.getElementById('stock-detail-price').innerText = s.price.toFixed(2) + " ‚Ç¨";
                document.getElementById('stock-owned').innerText = s.owned;
                let val = s.owned * s.price;
                document.getElementById('stock-val').innerText = val.toFixed(0) + " ‚Ç¨";

                if(!this.chart) {
                    const ctx = document.getElementById('stockChart').getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(50).fill(''),
                            datasets: [{ 
                                data: s.history, borderColor: '#00f3ff', tension: 0.1, pointRadius: 0, borderWidth: 2 
                            }]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, 
                            plugins: { legend: {display: false} },
                            scales: { x: {display: false}, y: {grid: {color:'#333'}} },
                            animation: false
                        }
                    });
                } else {
                    this.chart.data.datasets[0].data = s.history;
                    this.chart.update();
                }
            },

            trade: function(type) {
                let qty = parseInt(document.getElementById('stock-amount').value);
                let s = App.data.stocks[this.selected];
                if(type === 'buy') {
                    let cost = s.price * qty;
                    if(App.data.cash >= cost) {
                        App.data.cash -= cost; s.owned += qty;
                        UI.toast("Gekauft!", 'success');
                    } else UI.toast("Zu wenig Geld", 'error');
                } else {
                    if(s.owned >= qty) {
                        App.data.cash += s.price * qty; s.owned -= qty;
                        UI.toast("Verkauft!", 'success');
                    }
                }
                this.updateChart();
            },
            
            renderChart: function() {
                setTimeout(() => { if(this.chart) this.chart.resize(); }, 100);
            }
        };

        /* --- CASINO --- */
        const Casino = {
            playRoulette: function(choice) {
                let bet = parseInt(document.getElementById('roul-bet').value);
                if(!bet || App.data.cash < bet) return UI.toast("Einsatz ung√ºltig", 'error');
                App.data.cash -= bet;
                
                let wheel = document.getElementById('roul-wheel');
                wheel.style.transform = "rotate(720deg)";
                setTimeout(() => {
                    wheel.style.transform = "rotate(0deg)";
                    let win = Math.random() > 0.5 ? 'red' : 'black';
                    wheel.innerText = win === 'red' ? 'üî¥' : '‚ö´';
                    if(win === choice) {
                        App.data.cash += bet * 2;
                        UI.toast(`Gewonnen! +${bet*2}‚Ç¨`, 'success');
                    } else UI.toast("Verloren", 'error');
                }, 500);
            },

            playSlots: function() {
                let bet = parseInt(document.getElementById('slot-bet').value);
                if(!bet || App.data.cash < bet) return UI.toast("Einsatz ung√ºltig", 'error');
                App.data.cash -= bet;
                
                const syms = ['üçí','üçã','7Ô∏è‚É£','üíé'];
                let r1 = syms[Math.floor(Math.random()*4)];
                let r2 = syms[Math.floor(Math.random()*4)];
                let r3 = syms[Math.floor(Math.random()*4)];
                
                document.getElementById('slot1').innerText = r1;
                document.getElementById('slot2').innerText = r2;
                document.getElementById('slot3').innerText = r3;
                
                if(r1 === r2 && r2 === r3) {
                    let mult = r1 === '7Ô∏è‚É£' ? 50 : 10;
                    App.data.cash += bet * mult;
                    UI.toast(`JACKPOT! +${bet*mult}‚Ç¨`, 'success');
                }
            },

            startRace: function() {
                let bet = parseInt(document.getElementById('horse-bet').value);
                let choice = parseInt(document.getElementById('horse-select').value);
                if(!bet || App.data.cash < bet) return UI.toast("Einsatz ung√ºltig", 'error');
                App.data.cash -= bet;

                let horses = [0, 0, 0];
                let interval = setInterval(() => {
                    for(let i=0; i<3; i++) {
                        if(Math.random() > 0.3) horses[i] += Math.random() * 5;
                        let el = document.querySelector(`#lane-${i} .horse`);
                        el.style.left = horses[i] + "%";
                        
                        if(horses[i] >= 90) {
                            clearInterval(interval);
                            if(i === choice) {
                                App.data.cash += bet * 3;
                                UI.toast("Dein Pferd hat gewonnen!", 'success');
                            } else {
                                UI.toast(`Pferd ${i+1} hat gewonnen. Du verlierst.`, 'error');
                            }
                        }
                    }
                }, 50);
            },

            playBJ: function() {
                let bet = parseInt(document.getElementById('bj-bet').value);
                if(!bet || App.data.cash < bet) return UI.toast("Einsatz ung√ºltig", 'error');
                App.data.cash -= bet;
                
                let player = Math.floor(Math.random() * 10) + 12; // 12-21
                let dealer = Math.floor(Math.random() * 10) + 12;
                if(player > 21) player = 0;
                
                document.getElementById('bj-result').innerText = `${player} vs ${dealer}`;
                if(player > dealer) {
                    App.data.cash += bet * 2;
                    UI.toast("Blackjack Sieg!", 'success');
                } else {
                    UI.toast("Dealer gewinnt.", 'error');
                }
            }
        };

        /* --- ESTATE --- */
        const Estate = {
            props: [
                {id:1, n:"Kiosk", c:10000, i:100},
                {id:2, n:"Wohnung", c:50000, i:600},
                {id:3, n:"Hotel", c:200000, i:3000},
                {id:4, n:"Wolkenkratzer", c:1000000, i:15000}
            ],
            
            init: function() {
                if(App.data.estates.length === 0) App.data.estates = this.props.map(p => ({...p, owned: 0}));
                this.render();
            },

            tick: function() {
                let income = 0;
                App.data.estates.forEach(p => {
                    income += p.owned * p.i;
                });
                if(income > 0) {
                    App.data.cash += (income / 60); // Income per second calculation
                }
            },

            render: function() {
                let c = document.getElementById('estate-list');
                c.innerHTML = '';
                App.data.estates.forEach((p, i) => {
                    c.innerHTML += `
                    <div class="card">
                        <div class="card-header"><span class="card-title">${p.n}</span></div>
                        <h2 style="color:var(--neon-green)">+${p.i}‚Ç¨ / Min</h2>
                        <p>Besitz: <b>${p.owned}</b></p>
                        <button class="btn btn-primary btn-full" onclick="Estate.buy(${i})">Kaufen (${p.c.toLocaleString()}‚Ç¨)</button>
                    </div>`;
                });
            },

            buy: function(index) {
                let p = App.data.estates[index];
                if(App.data.cash >= p.c) {
                    App.data.cash -= p.c;
                    p.owned++;
                    this.render();
                    UI.toast("Immobilie gekauft!", 'success');
                } else UI.toast("Zu wenig Geld", 'error');
            }
        };

        // START
        App.init();

    </script>
</body>
</html>
