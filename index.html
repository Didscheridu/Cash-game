<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Imperium: Ultimate Tycoon</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --border: #334155;
            --accent: #38bdf8; --green: #22c55e; --red: #ef4444; --gold: #eab308;
            --text: #f8fafc;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; user-select: none; }
        
        /* ANIMATIONS */
        @keyframes pop { 0% { transform: scale(0.95); opacity:0; } 100% { transform: scale(1); opacity:1; } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

        /* UI COMPONENTS */
        .view { display: none; height: 100vh; padding: 20px; box-sizing: border-box; overflow-y: auto; max-width: 1600px; margin: 0 auto; }
        .view.active { display: block; animation: pop 0.3s ease-out; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn { background: var(--border); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { filter: brightness(1.2); }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: var(--green); color: black; }
        .btn-red { background: var(--red); color: white; }
        .btn-accent { background: var(--accent); color: black; }
        .btn-gold { background: var(--gold); color: black; }

        input, select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }

        /* MENU GRID */
        #menu { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at top, #1e293b 0%, #0b1120 100%); }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 900px; width: 100%; padding: 20px; }
        .card { background: var(--panel); padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; border: 1px solid var(--border); transition: 0.3s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* STOCK MARKET */
        .stock-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 85vh; }
        .list-panel { background: var(--panel); border-radius: 12px; overflow-y: auto; border: 1px solid var(--border); }
        .detail-panel { background: var(--panel); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #0f172a; padding: 15px; text-align: left; z-index: 2; color: #94a3b8; border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
        tr:hover { background: #334155; cursor: pointer; }
        .row-up { color: var(--green); } .row-down { color: var(--red); }

        /* COMPANY / TYCOON */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; background: var(--panel); border: 1px solid var(--border); color: #888; cursor: pointer; text-align: center; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .tab.active { background: var(--accent); color: black; border-color: var(--accent); }
        .section { display: none; animation: pop 0.2s; }
        .section.active { display: block; }
        
        .dash-stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        
        /* Product Cards */
        .prod-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .prod-card { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 10px; }
        .progress-bar-bg { background: #000; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.2s linear; }

        /* Real Estate Grid */
        .estate-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .estate-card { background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid var(--border); position: relative; }
        .estate-status { position: absolute; top: 10px; right: 10px; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; background: #333; }

        /* NOTIFICATIONS */
        #notif-area { position: fixed; bottom: 20px; right: 20px; z-index: 999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notif { background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--accent); padding: 15px; width: 300px; color: white; border-radius: 6px; animation: slideIn 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; border: 1px solid var(--accent); width: 90%; max-width: 500px; }
    </style>
</head>
<body>

    <div id="notif-area"></div>

    <div id="menu">
        <h1 style="color:var(--accent); font-size:4em; margin:0; letter-spacing: 5px; text-transform: uppercase;">TYCOON</h1>
        <p style="color:#64748b; margin-bottom: 30px;">ULTIMATE EDITION</p>
        <h2 style="color:var(--green); font-family:monospace; font-size:3em; margin-bottom:50px;" class="display-cash"></h2>
        
        <div class="menu-grid">
            <div class="card" onclick="nav('company')"><h1>üè≠</h1><h2>Firma Gr√ºnden</h2><p>Produktion oder Handel</p></div>
            <div class="card" onclick="nav('stocks')"><h1>üìà</h1><h2>Aktienmarkt</h2><p>Full-Screen Trading</p></div>
            <div class="card" onclick="nav('estate')"><h1>üèôÔ∏è</h1><h2>Immobilien</h2><p>Verhandeln & Vermieten</p></div>
            <div class="card" onclick="nav('loot')"><h1>üéí</h1><h2>Auktionen</h2><p>Items & Inventar</p></div>
            <div class="card" onclick="nav('casino')"><h1>üé∞</h1><h2>Casino</h2><p>Slots & Roulette</p></div>
        </div>
    </div>

    <div id="view-company" class="view">
        <div class="top-bar">
            <button class="btn" onclick="nav('menu')">üè† Men√º</button>
            <span class="display-cash" style="font-size:1.5em; font-family:monospace; color:var(--green)"></span>
        </div>

        <div id="comp-create" style="max-width:500px; margin: 50px auto; text-align: center;">
            <h1 style="color:var(--accent)">Unternehmen gr√ºnden</h1>
            <p style="color:#888; margin-bottom: 20px;">W√§hle dein Gesch√§ftsmodell.</p>
            
            <input id="c-name" placeholder="Firmenname (z.B. Omega Corp)" style="font-size:1.2em; margin-bottom: 10px;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <div class="card" onclick="selectType('factory')" id="type-factory" style="border:2px solid transparent">
                    <h1>üè≠</h1><h3>Fabrik</h3>
                    <small>Rohstoffe einkaufen,<br>Produkte designen,<br>Herstellen.</small>
                </div>
                <div class="card" onclick="selectType('trade')" id="type-trade" style="border:2px solid transparent">
                    <h1>‚öñÔ∏è</h1><h3>Handel</h3>
                    <small>G√ºnstig am Markt kaufen,<br>Teurer an Kunden<br>verkaufen.</small>
                </div>
            </div>
            
            <p style="color:var(--gold)">Startkapital: 25.000 ‚Ç¨</p>
            <button class="btn btn-green" style="width:100%; font-size:1.2em; padding:15px;" onclick="startCompany()">Gr√ºndung unterschreiben ‚úçÔ∏è</button>
        </div>

        <div id="comp-dash" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 id="comp-title-display" style="margin:0; text-transform:uppercase; letter-spacing:2px;">FIRMA</h1>
                <div style="text-align:right">
                    <span id="comp-type-display" style="background:#333; padding:5px 10px; border-radius:5px; font-size:0.8em; color:#aaa">TYP</span>
                </div>
            </div>

            <div class="dash-stats">
                <div class="stat-box">üë®‚Äçüíº Mitarbeiter<br><span id="stat-emp" style="font-size:1.5em; font-weight:bold">0</span></div>
                <div class="stat-box">üí∏ Lohnkosten<br><span id="stat-wages" style="font-size:1.5em; font-weight:bold; color:var(--red)">0</span></div>
                <div class="stat-box">üì¶ Lagerwert<br><span id="stat-stock-val" style="font-size:1.5em; font-weight:bold; color:var(--gold)">0</span></div>
                <div class="stat-box">‚≠ê Ruf<br><span id="stat-rep" style="font-size:1.5em; font-weight:bold; color:var(--accent)">1</span></div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchCompTab('ops')">‚öôÔ∏è Operationen</div>
                <div class="tab" onclick="switchCompTab('staff')">üë• Personal</div>
                <div class="tab" onclick="switchCompTab('market')">üõí Markt / Produkte</div>
            </div>

            <div id="ctab-ops" class="section active">
                <div id="factory-view" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2>Laufende Produktion</h2>
                        <button class="btn btn-accent" onclick="openProductDesigner()">+ Neues Produkt designen</button>
                    </div>
                    <div id="prod-list" class="prod-grid"></div>
                </div>

                <div id="trade-view" style="display:none;">
                    <h2>Aktiver Handel</h2>
                    <p style="color:#888">Deine Verk√§ufer verkaufen automatisch Ware aus dem Lager.</p>
                    <div class="prod-grid">
                        <div class="prod-card">
                            <h3>Lagerbestand</h3>
                            <h1 id="trade-stock" style="color:var(--gold)">0</h1>
                            <p>Einheiten bereit zum Verkauf</p>
                        </div>
                        <div class="prod-card">
                            <h3>Verk√§ufe letzte Minute</h3>
                            <h1 id="trade-sales">0</h1>
                            <p style="color:var(--green)">Umsatz generiert</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ctab-staff" class="section">
                <h2>Personalabteilung</h2>
                <div class="prod-grid">
                    <div class="prod-card">
                        <h3>üîµ Eink√§ufer</h3>
                        <p>Kaufen Rohstoffe / Handelswaren automatisch g√ºnstig ein.</p>
                        <h1><span id="staff-buy">0</span></h1>
                        <button class="btn btn-green" onclick="hire('buy')">Hire (500‚Ç¨)</button> <button class="btn btn-red" onclick="fire('buy')">Fire</button>
                    </div>
                    <div id="staff-prod-card" class="prod-card">
                        <h3>üü° Produzenten</h3>
                        <p>Arbeiten am Flie√üband.</p>
                        <h1><span id="staff-make">0</span></h1>
                        <button class="btn btn-green" onclick="hire('make')">Hire (500‚Ç¨)</button> <button class="btn btn-red" onclick="fire('make')">Fire</button>
                    </div>
                    <div class="prod-card">
                        <h3>üü¢ Verk√§ufer</h3>
                        <p>Verkaufen fertige Produkte an Kunden.</p>
                        <h1><span id="staff-sell">0</span></h1>
                        <button class="btn btn-green" onclick="hire('sell')">Hire (500‚Ç¨)</button> <button class="btn btn-red" onclick="fire('sell')">Fire</button>
                    </div>
                </div>
            </div>

            <div id="ctab-market" class="section">
                <h2 id="market-title">Rohstoffmarkt</h2>
                <p id="market-desc">Preise √§ndern sich alle 5 Sekunden.</p>
                <div id="market-list" class="prod-grid"></div>
            </div>
        </div>
    </div>

    <div id="view-estate" class="view">
        <div class="top-bar"><button class="btn" onclick="nav('menu')">üè† Men√º</button><span class="display-cash"></span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h2>Immobilienmarkt</h2>
            <p>N√§chste Miete: <span id="rent-timer" style="color:var(--accent); font-weight:bold;">15s</span></p>
        </div>
        <div id="estate-buy-list" class="estate-grid" style="margin-bottom:30px;"></div>
        <hr style="border-color:var(--border)">
        <h2>Mein Besitz</h2>
        <div id="my-estate-list" class="estate-grid"></div>
    </div>

    <div id="view-stocks" class="view">
        <div class="top-bar"><button class="btn" onclick="nav('menu')">üè† Men√º</button><span class="display-cash"></span></div>
        <div class="stock-layout">
            <div class="list-panel"><table><thead><tr><th>Symbol</th><th>Kurs</th></tr></thead><tbody id="stock-list"></tbody></table></div>
            <div class="detail-panel">
                <div style="display:flex; justify-content:space-between;"><h1 id="st-name">Apple</h1><h1 id="st-price">--</h1></div>
                <div style="flex:1; position:relative;"><canvas id="chart"></canvas></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
                    <input id="st-qty" type="number" value="10" style="grid-column:span 2">
                    <button class="btn btn-green" onclick="tradeStock('buy')">Kaufen</button>
                    <button class="btn btn-red" onclick="tradeStock('sell')">Verkaufen</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-product" class="modal">
        <div class="modal-content">
            <h2>Neues Produkt entwerfen</h2>
            <input id="new-prod-name" placeholder="Produktname (z.B. iPhone 20)">
            <p>Ben√∂tigte Materialien:</p>
            <div id="mat-select-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; text-align:left; max-height:200px; overflow-y:auto;"></div>
            <p>Herstellungskosten: <span id="design-cost" style="color:var(--red)">0 ‚Ç¨</span></p>
            <p>Verkaufspreis: <span id="design-price" style="color:var(--green)">0 ‚Ç¨</span></p>
            <button class="btn btn-accent" style="width:100%" onclick="createProduct()">Entwurf speichern</button>
            <button class="btn" style="width:100%; margin-top:5px;" onclick="closeModals()">Abbrechen</button>
        </div>
    </div>

    <div id="modal-neg" class="modal">
        <div class="modal-content">
            <h2>Mietvertrag aushandeln</h2>
            <p>Marktwert: <span id="neg-market" style="color:var(--accent)"></span> ‚Ç¨</p>
            <input id="neg-offer" type="number" placeholder="Deine Forderung">
            <br><br>
            <button class="btn btn-green" onclick="submitRent()">Angebot senden</button>
            <button class="btn" onclick="closeModals()">Abbrechen</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let cash = 50000;
        let company = null;
        let selectedType = '';
        let rentTimer = 15;
        let myProps = [];
        let stocks = [];
        
        // Database
        const materials = [
            {id:'wood', n:'Holz', c:5}, {id:'steel', n:'Stahl', c:20}, {id:'plastic', n:'Plastik', c:10},
            {id:'glass', n:'Glas', c:15}, {id:'silicon', n:'Silizium', c:50}, {id:'gold', n:'Gold', c:200}
        ];
        const estateDB = [
            {n:"Wohnung", c:5000, m:300, i:"üè†"}, {n:"Penthouse", c:50000, m:2500, i:"üè¢"},
            {n:"Laden", c:15000, m:1000, i:"üè™"}, {n:"Fabrik", c:100000, m:6000, i:"üè≠"}
        ];
        const stockNames = ["TechCorp", "Banana", "SoftMicro", "GigaNet", "SpaceX", "SolarCity", "PharmaPlus"];

        // --- INIT ---
        stockNames.forEach((n,i) => stocks.push({id:i, name:n, price:Math.random()*100+50, hist:Array(40).fill(100), owned:0}));
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {type:'line', data:{labels:Array(40).fill(''), datasets:[{data:[], borderColor:'#38bdf8', borderWidth:2, pointRadius:0, tension:0.1}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:false}, scales:{x:{display:false}, y:{grid:{color:'#334155'}}}}});

        // --- CORE FUNCTIONS ---
        function fmt(n) { return n.toLocaleString('de-DE', {style:'currency', currency:'EUR'}); }
        function notify(msg, type='good') {
            let n=document.createElement('div'); n.className='notif'; n.innerText=msg; 
            n.style.borderColor=type==='bad'?'var(--red)':'var(--accent)';
            document.getElementById('notif-area').appendChild(n); setTimeout(()=>n.remove(),3000);
        }
        function ui() {
            document.querySelectorAll('.display-cash').forEach(e=>e.innerText=fmt(cash));
            if(company) updateCompanyUI();
        }
        function nav(id) {
            document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
            document.getElementById('menu').style.display=id==='menu'?'flex':'none';
            if(id!=='menu') document.getElementById('view-'+id).classList.add('active');
            if(id==='stocks') setTimeout(()=>chart.resize(),100);
            if(id==='estate') renderEstate();
        }
        function closeModals() { document.querySelectorAll('.modal').forEach(e=>e.style.display='none'); }

        // --- COMPANY SYSTEM ---
        function selectType(t) {
            selectedType = t;
            document.getElementById('type-factory').style.borderColor = t==='factory'?'var(--accent)':'transparent';
            document.getElementById('type-trade').style.borderColor = t==='trade'?'var(--accent)':'transparent';
        }

        function startCompany() {
            let name = document.getElementById('c-name').value;
            if(!name || !selectedType) return alert("Name und Typ w√§hlen!");
            if(cash<25000) return alert("Zu wenig Geld!");
            cash-=25000;
            
            company = {
                name: name, type: selectedType,
                staff: {buy:0, make:0, sell:0},
                products: [], // For Factory
                inventory: 0, // For Trade
                materials: {} // Raw storage
            };
            materials.forEach(m => company.materials[m.id] = 0);

            document.getElementById('comp-create').style.display='none';
            document.getElementById('comp-dash').style.display='block';
            document.getElementById('comp-title-display').innerText = name;
            document.getElementById('comp-type-display').innerText = selectedType==='factory'?'FABRIK':'HANDEL';
            
            // Adjust UI based on type
            if(selectedType==='factory') {
                document.getElementById('factory-view').style.display='block';
                document.getElementById('staff-prod-card').style.display='block';
                document.getElementById('market-title').innerText = "Rohstoffmarkt";
                document.getElementById('market-desc').innerText = "Kaufe Materialien f√ºr deine Produktion.";
            } else {
                document.getElementById('trade-view').style.display='block';
                document.getElementById('staff-prod-card').style.display='none'; // Handel braucht keine Produktion
                document.getElementById('market-title').innerText = "Gro√ühandel";
                document.getElementById('market-desc').innerText = "Kaufe Waren g√ºnstig ein (Preise schwanken).";
            }
            renderMarket();
            ui();
        }

        function switchCompTab(t) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            document.getElementById('ctab-'+t).classList.add('active');
            event.target.classList.add('active');
        }

        function hire(role) { if(cash>=500){cash-=500; company.staff[role]++; ui();} }
        function fire(role) { if(company.staff[role]>0){company.staff[role]--; ui();} }

        // Factory: Product Design
        let designMats = [];
        function openProductDesigner() {
            document.getElementById('modal-product').style.display='flex';
            let g = document.getElementById('mat-select-grid'); g.innerHTML="";
            designMats = [];
            materials.forEach(m => {
                g.innerHTML += `<label><input type="checkbox" onchange="toggleMat('${m.id}')"> ${m.n} (${m.c}‚Ç¨)</label>`;
            });
            updateDesignCost();
        }
        function toggleMat(id) {
            if(designMats.includes(id)) designMats=designMats.filter(x=>x!==id); else designMats.push(id);
            updateDesignCost();
        }
        function updateDesignCost() {
            let cost = 0; designMats.forEach(id=>cost+=materials.find(m=>m.id===id).c);
            document.getElementById('design-cost').innerText=fmt(cost);
            document.getElementById('design-price').innerText=fmt(cost*2.5);
        }
        function createProduct() {
            let n = document.getElementById('new-prod-name').value;
            if(!n || designMats.length===0) return;
            let cost=0; designMats.forEach(id=>cost+=materials.find(m=>m.id===id).c);
            
            company.products.push({
                name: n, mats: [...designMats], cost: cost, price: cost*2.5,
                stock: 0, progress: 0
            });
            renderProdList();
            closeModals();
            notify("Produkt entworfen!");
        }
        function renderProdList() {
            let d = document.getElementById('prod-list'); d.innerHTML="";
            company.products.forEach(p => {
                d.innerHTML += `
                <div class="prod-card">
                    <h3>${p.name}</h3>
                    <p>Lager: <span style="color:var(--gold); font-weight:bold">${p.stock}</span></p>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${p.progress}%"></div></div>
                    <small>Preis: ${fmt(p.price)}</small>
                </div>`;
            });
        }

        // Market System (Buy Raw or Trade Goods)
        function renderMarket() {
            let d = document.getElementById('market-list'); d.innerHTML="";
            if(company.type==='factory') {
                materials.forEach(m => {
                    d.innerHTML += `<div class="prod-card"><h3>${m.n}</h3><p>Preis: ${m.c}‚Ç¨</p><p>Lager: ${company.materials[m.id]}</p><button class="btn btn-green" onclick="buyMat('${m.id}', ${m.c})">Kaufen</button></div>`;
                });
            } else {
                // Trading items
                d.innerHTML = `<div class="prod-card"><h3>Elektronik-Mix</h3><p>Marktpreis: <span id="trade-price">100</span>‚Ç¨</p><button class="btn btn-green" onclick="buyTradeItem()">Kaufen</button></div>`;
            }
        }
        let tradePrice = 100;
        setInterval(()=>{ tradePrice = Math.floor(Math.random()*50 + 80); if(company && company.type==='trade') renderMarket(); }, 5000);

        function buyMat(id, cost) { if(cash>=cost){cash-=cost; company.materials[id]++; ui(); renderMarket();} }
        function buyTradeItem() { if(cash>=tradePrice){cash-=tradePrice; company.inventory++; ui();} }

        // COMPANY LOOP (100ms)
        setInterval(() => {
            if(!company) return;

            // 1. BUYERS (Auto-buy raw/goods if cash available)
            if(company.staff.buy > 0) {
                if(company.type === 'factory') {
                    // Simple logic: keep 10 of each material
                    materials.forEach(m => {
                        if(company.materials[m.id] < 10 && cash >= m.c) {
                            if(Math.random() < 0.1 * company.staff.buy) { cash-=m.c; company.materials[m.id]++; }
                        }
                    });
                } else {
                    // Trade: Buy if price is low (<100)
                    if(tradePrice < 100 && cash >= tradePrice) {
                        if(Math.random() < 0.1 * company.staff.buy) { cash-=tradePrice; company.inventory++; }
                    }
                }
            }

            // 2. PRODUCERS (Factory Only)
            if(company.type === 'factory' && company.staff.make > 0 && company.products.length > 0) {
                // Work on random product
                let p = company.products[Math.floor(Math.random()*company.products.length)];
                // Check materials
                let canBuild = true;
                p.mats.forEach(mid => { if(company.materials[mid]<=0) canBuild=false; });
                
                if(canBuild) {
                    p.progress += company.staff.make; // Speed based on staff
                    if(p.progress >= 100) {
                        p.progress = 0;
                        p.mats.forEach(mid => company.materials[mid]--);
                        p.stock++;
                    }
                }
                if(document.getElementById('view-company').style.display!=='none') renderProdList(); // Refresh bars
            }

            // 3. SELLERS
            if(company.staff.sell > 0) {
                if(company.type === 'factory') {
                    company.products.forEach(p => {
                        if(p.stock > 0 && Math.random() < 0.05 * company.staff.sell) {
                            p.stock--; cash += p.price;
                        }
                    });
                } else {
                    if(company.inventory > 0 && Math.random() < 0.05 * company.staff.sell) {
                        company.inventory--; cash += 130; // Sell for fixed margin avg
                    }
                }
            }

            // Wages (every 30s logic simplified here for tick)
            if(Math.random() < 0.003) { // Roughly every few seconds small deduction visual, but real logic:
                let wages = (company.staff.buy+company.staff.make+company.staff.sell)*10;
                if(wages>0) {
                    if(cash>=wages) cash-=wages; 
                    else { company.staff.buy=0; company.staff.make=0; company.staff.sell=0; notify("Streik! Personal weg.", "bad"); }
                }
            }
            
            ui();
        }, 100);

        function updateCompanyUI() {
            document.getElementById('stat-emp').innerText = company.staff.buy+company.staff.make+company.staff.sell;
            let val = 0;
            if(company.type==='factory') company.products.forEach(p=>val+=p.stock*p.price);
            else val = company.inventory*100;
            document.getElementById('stat-stock-val').innerText = fmt(val);
            document.getElementById('stat-wages').innerText = fmt((company.staff.buy+company.staff.make+company.staff.sell)*500) + "/mo";
            
            document.getElementById('staff-buy').innerText = company.staff.buy;
            document.getElementById('staff-make').innerText = company.staff.make;
            document.getElementById('staff-sell').innerText = company.staff.sell;
            
            if(company.type==='trade') {
                document.getElementById('trade-stock').innerText = company.inventory;
                document.getElementById('trade-sales').innerText = tradePrice; // Just showing current market price here
            } else {
                renderMarket(); // Refresh raw mat counts
            }
        }

        // --- REAL ESTATE ---
        let negIdx = 0;
        function renderEstate() {
            let l1 = document.getElementById('estate-buy-list'); l1.innerHTML="";
            estateDB.forEach((p,i) => l1.innerHTML+=`<div class="estate-card"><h1>${p.i}</h1><h3>${p.n}</h3><p>Miete: ~${p.m}‚Ç¨</p><button class="btn btn-green" onclick="buyProp(${i})">Kaufen ${fmt(p.c)}</button></div>`);
            let l2 = document.getElementById('my-estate-list'); l2.innerHTML="";
            myProps.forEach((p,i) => {
                let st = p.tenant ? `<span style="color:var(--green)">Vermietet (${p.rent}‚Ç¨)</span>` : `<button class="btn" onclick="openNeg(${i})">Mieter suchen</button>`;
                l2.innerHTML+=`<div class="estate-card"><h3>${p.n}</h3>${st}</div>`;
            });
        }
        function buyProp(i) { if(cash>=estateDB[i].c){cash-=estateDB[i].c; myProps.push({...estateDB[i], tenant:false, rent:0}); renderEstate(); ui();} }
        function openNeg(i) { negIdx=i; document.getElementById('neg-market').innerText=myProps[i].m; document.getElementById('modal-neg').style.display='flex'; }
        function submitRent() {
            let offer = parseInt(document.getElementById('neg-offer').value);
            let p = myProps[negIdx];
            if(Math.random() < (p.m/offer)) { p.tenant=true; p.rent=offer; notify("Vermietet!"); closeModals(); renderEstate(); }
            else notify("Abgelehnt", "bad");
        }
        setInterval(()=>{
            rentTimer--;
            if(rentTimer<=0) { rentTimer=15; let inc=0; myProps.forEach(p=>{if(p.tenant)inc+=p.rent}); if(inc>0){cash+=inc; notify(`Miete: +${fmt(inc)}`); ui();} }
            let el = document.getElementById('rent-timer'); if(el) el.innerText=rentTimer+"s";
        }, 1000);

        // --- STOCKS (Simple) ---
        setInterval(()=>{
            stocks.forEach(s=>{ s.price+=(Math.random()-0.5)*5; if(s.price<1)s.price=1; s.hist.shift(); s.hist.push(s.price); });
            if(document.getElementById('view-stocks').classList.contains('active')) {
                let h=""; stocks.forEach(s=>h+=`<tr onclick="selStock(${s.id})"><td class="${s.price>s.hist[38]?'row-up':'row-down'}"><b>${s.ticker}</b></td><td>${s.price.toFixed(2)}</td></tr>`);
                document.getElementById('stock-list').innerHTML=h; updateChart();
            }
        }, 1000);
        let selStockId=0;
        function selStock(id){selStockId=id;updateChart();}
        function updateChart(){ 
            let s=stocks[selStockId]; document.getElementById('st-name').innerText=s.name; document.getElementById('st-price').innerText=s.price.toFixed(2)+"‚Ç¨";
            chart.data.datasets[0].data=s.hist; chart.update('none');
        }
        function tradeStock(t){
            let s=stocks[selStockId]; let q=10;
            if(t==='buy'&&cash>=s.price*q){cash-=s.price*q; s.owned+=q;}
            if(t==='sell'&&s.owned>=q){cash+=s.price*q; s.owned-=q;}
            ui();
        }

        // Init
        ui();
    </script>
</body>
</html>
